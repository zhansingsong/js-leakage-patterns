è¿™æ˜¯å…³äº JavaScript å†…å­˜æ³„éœ²å’Œ CSS ä¼˜åŒ–ç›¸å…³åºåˆ—æ–‡ç« ï¼ˆæ•´ç†ä¸­â€¦â€¦ï¼‰ã€‚ç”±äºæ—¶é—´æœ‰é™æ›´æ–°è¿›åº¦ä¼šæœ‰ç‚¹æ…¢ï¼Œä½†ä¼šæŒç»­æ›´æ–°çš„ã€‚è‡ªå·±ä¹Ÿåœ¨å­¦ä¹ ä¸­ï¼Œéš¾å…å¯¹æŸäº›çŸ¥è¯†ç‚¹çš„ç†è§£ä¸æ˜¯å¾ˆæ­£ç¡®ï¼Œæ‰€ä»¥æ‰å°†æ–‡ç« æ”¾ç½® github ä¸Šï¼Œä¸€æ˜¯æƒ³ä¸å¤§å®¶åˆ†äº«ï¼ŒäºŒæ˜¯æ–¹ä¾¿æŒç»­æ›´æ–°ï¼Œä¸‰æ˜¯ä¾¿äºå®æ—¶ä¿®æ­£é”™è¯¯ç‚¹ã€‚ä¹Ÿå¸Œæœ›çœ‹æœ¬æ–‡çš„å„ä½åŒå­¦èƒ½å¤šæ issuesï¼Œæˆ‘ä¼šæ ¹æ®æçš„æ„è§ä¸æ–­å®Œå–„æ–‡ç« ã€‚æœ€åå¸Œæœ›å„ä½èƒ½ä»æ–‡ç« ä¸­æœ‰æ‰€æ”¶è·----->:tada: enjoy reading, enjoy life :whale:

### åºåˆ—æ–‡ç« é“¾æ¥

* JavaScriptï¼š
  * [JavaScript å†…å­˜é‚£ç‚¹äº‹](./JavaScriptå†…å­˜é‚£ç‚¹äº‹/JavaScriptå†…å­˜é‚£ç‚¹äº‹.md)
  * [å¸¸è§çš„ JavaScript å†…å­˜æ³„éœ²](./å¸¸è§çš„JavaScriptå†…å­˜æ³„éœ²/å¸¸è§çš„JavaScriptå†…å­˜æ³„éœ².md)
  * [IE<8 å¾ªç¯å¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„éœ²](./IE<8å¾ªç¯å¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„éœ²/IE<8å¾ªç¯å¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„éœ².md)
  * [å†…å­˜æ³„éœ²ä¹‹ jQuery.cache](./å†…å­˜æ³„éœ²ä¹‹jQuery.cache/å†…å­˜æ³„éœ²ä¹‹jQuery.cache.md)
  * [å†…å­˜æ³„éœ²ä¹‹ Listeners](./å†…å­˜æ³„éœ²ä¹‹Listeners/å†…å­˜æ³„éœ²ä¹‹Listeners.md)
  * [requestAnimationFrame](./requestAnimationFrame/requestAnimationFrame.md)
* CSS:
  * [æµè§ˆå™¨æ¸²æŸ“ç®€è¿°](./æµè§ˆå™¨æ¸²æŸ“ç®€è¿°/æµè§ˆå™¨æ¸²æŸ“ç®€è¿°.md)
  * [å…³äºå¤–éƒ¨æ ·å¼è¡¨ä¹Ÿè®¸ä½ ä¸çŸ¥é“çš„äº‹](./å…³äºå¤–éƒ¨æ ·å¼è¡¨ä¹Ÿè®¸ä½ ä¸çŸ¥é“çš„äº‹/å…³äºå¤–éƒ¨æ ·å¼è¡¨ä¹Ÿè®¸ä½ ä¸çŸ¥é“çš„äº‹.md)
* IMAGE
  * [WebPå®æˆ˜](./WebPå®æˆ˜/WebPå®æˆ˜.md)
  * [Mediumæ¸è¿›æ€§æ‡’åŠ è½½](./Mediumæ¸è¿›æ€§æ‡’åŠ è½½/Mediumæ¸è¿›æ€§æ‡’åŠ è½½.md)

#### <u style="color:#ab2251"> :no_entry:å£°æ˜: æœ¬èµ„æ–™ä»…ä¾›å­¦ä¹ äº¤æµ! å¦‚éœ€è½¬è½½ï¼Œè¯·æ³¨æ˜å‡ºå¤„ã€‚</u>

---

# å¸¸è§çš„ JavaScript å†…å­˜æ³„éœ²

![](./images/head.jpg)

## ä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²

> **å†…å­˜æ³„æ¼**æŒ‡ç”±äºç–å¿½æˆ–é”™è¯¯é€ æˆç¨‹åºæœªèƒ½é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚å†…å­˜æ³„æ¼å¹¶éæŒ‡å†…å­˜åœ¨ç‰©ç†ä¸Šçš„æ¶ˆå¤±ï¼Œè€Œæ˜¯åº”ç”¨ç¨‹åºåˆ†é…æŸæ®µå†…å­˜åï¼Œç”±äºè®¾è®¡é”™è¯¯ï¼Œå¯¼è‡´åœ¨é‡Šæ”¾è¯¥æ®µå†…å­˜ä¹‹å‰å°±å¤±å»äº†å¯¹è¯¥æ®µå†…å­˜çš„æ§åˆ¶ï¼Œä»è€Œé€ æˆäº†å†…å­˜çš„æµªè´¹ã€‚å†…å­˜æ³„æ¼é€šå¸¸æƒ…å†µä¸‹åªèƒ½ç”±è·å¾—ç¨‹åºæºä»£ç çš„ç¨‹åºå‘˜æ‰èƒ½åˆ†æå‡ºæ¥ã€‚ç„¶è€Œï¼Œæœ‰ä¸å°‘äººä¹ æƒ¯äºæŠŠä»»ä½•ä¸éœ€è¦çš„å†…å­˜ä½¿ç”¨çš„å¢åŠ æè¿°ä¸ºå†…å­˜æ³„æ¼ï¼Œå³ä½¿ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´è¿™æ˜¯ä¸å‡†ç¡®çš„ã€‚
> â€”â€”â€”â€”[wikipedia](https://zh.wikipedia.org/wiki/%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F)

**âš ï¸ æ³¨ï¼šä¸‹æ–‡ä¸­æ ‡æ³¨çš„ CG æ˜¯ Chrome æµè§ˆå™¨ä¸­ Devtools çš„ã€Collect garbageã€‘æŒ‰é’®ç¼©å†™ï¼Œè¡¨ç¤ºå›æ”¶åƒåœ¾æ“ä½œã€‚**
![cg](https://raw.githubusercontent.com/zhansingsong/js-leakage-patterns/master/images/CG.png)

## æ„å¤–çš„å…¨å±€å˜é‡

JavaScript å¯¹æœªå£°æ˜å˜é‡çš„å¤„ç†æ–¹å¼ï¼šåœ¨å…¨å±€å¯¹è±¡ä¸Šåˆ›å»ºè¯¥å˜é‡çš„å¼•ç”¨(å³å…¨å±€å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œä¸æ˜¯å˜é‡ï¼Œå› ä¸ºå®ƒèƒ½é€šè¿‡`delete`åˆ é™¤)ã€‚å¦‚æœåœ¨æµè§ˆå™¨ä¸­ï¼Œå…¨å±€å¯¹è±¡å°±æ˜¯**window**å¯¹è±¡ã€‚

å¦‚æœæœªå£°æ˜çš„å˜é‡ç¼“å­˜å¤§é‡çš„æ•°æ®ï¼Œä¼šå¯¼è‡´è¿™äº›æ•°æ®åªæœ‰åœ¨çª—å£å…³é—­æˆ–é‡æ–°åˆ·æ–°é¡µé¢æ—¶æ‰èƒ½è¢«é‡Šæ”¾ã€‚è¿™æ ·ä¼šé€ æˆæ„å¤–çš„å†…å­˜æ³„æ¼ã€‚

```js
function foo(arg) {
  bar = 'this is a hidden global variable with a large of data';
}
```

ç­‰åŒäºï¼š

```js
function foo(arg) {
  window.bar = 'this is an explicit global variable with a large of data';
}
```

å¦å¤–ï¼Œé€šè¿‡**this**åˆ›å»ºæ„å¤–çš„å…¨å±€å˜é‡ï¼š

```js
function foo() {
  this.variable = 'potential accidental global';
}

// å½“åœ¨å…¨å±€ä½œç”¨åŸŸä¸­è°ƒç”¨fooå‡½æ•°ï¼Œæ­¤æ—¶thisæŒ‡å‘çš„æ˜¯å…¨å±€å¯¹è±¡(window)ï¼Œè€Œä¸æ˜¯'undefined'
foo();
```

### è§£å†³æ–¹æ³•ï¼š

åœ¨ JavaScript æ–‡ä»¶ä¸­æ·»åŠ `'use strict'`ï¼Œå¼€å¯ä¸¥æ ¼æ¨¡å¼ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é¿å…ä¸Šè¿°é—®é¢˜ã€‚

```js
function foo(arg) {
  'use strict'; // åœ¨fooå‡½æ•°ä½œç”¨åŸŸå†…å¼€å¯ä¸¥æ ¼æ¨¡å¼
  bar = 'this is an explicit global variable with a large of data'; // æŠ¥é”™ï¼šå› ä¸ºbarè¿˜æ²¡æœ‰è¢«å£°æ˜
}
```

å¦‚æœéœ€è¦åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ä½¿ç”¨å…¨å±€å˜é‡ï¼Œå¯ä»¥åƒå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œåœ¨**window**ä¸Šæ˜ç¡®å£°æ˜ï¼š

```js
function foo(arg) {
  window.bar = 'this is a explicit global variable with a large of data';
}
```

è¿™æ ·ä¸ä»…å¯è¯»æ€§é«˜ï¼Œè€Œä¸”åæœŸç»´æŠ¤ä¹Ÿæ–¹ä¾¿

> è°ˆåˆ°å…¨å±€å˜é‡ï¼Œéœ€è¦æ³¨æ„é‚£äº›ç”¨æ¥ä¸´æ—¶å­˜å‚¨å¤§é‡æ•°æ®çš„å…¨å±€å˜é‡ï¼Œç¡®ä¿åœ¨å¤„ç†å®Œè¿™äº›æ•°æ®åå°†å…¶è®¾ç½®ä¸º null æˆ–é‡æ–°èµ‹å€¼ã€‚å…¨å±€å˜é‡ä¹Ÿå¸¸ç”¨æ¥åš cacheï¼Œä¸€èˆ¬ cache éƒ½æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–æ‰ç”¨åˆ°çš„ï¼Œä¸ºäº†æ€§èƒ½ï¼Œæœ€å¥½å¯¹ cache çš„å¤§å°åšä¸ªä¸Šé™é™åˆ¶ã€‚å› ä¸º cache æ˜¯ä¸èƒ½è¢«å›æ”¶çš„ï¼Œè¶Šé«˜ cache ä¼šå¯¼è‡´è¶Šé«˜çš„å†…å­˜æ¶ˆè€—ã€‚

## console.log

`console.log`ï¼šå‘ web å¼€å‘æ§åˆ¶å°æ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼Œå¸¸ç”¨æ¥åœ¨å¼€å‘æ—¶è°ƒè¯•åˆ†æã€‚æœ‰æ—¶åœ¨å¼€å‘æ—¶ï¼Œéœ€è¦æ‰“å°ä¸€äº›å¯¹è±¡ä¿¡æ¯ï¼Œä½†å‘å¸ƒæ—¶å´å¿˜è®°å»æ‰`console.log`è¯­å¥ï¼Œè¿™å¯èƒ½é€ æˆå†…å­˜æ³„éœ²ã€‚

åœ¨ä¼ é€’ç»™`console.log`çš„å¯¹è±¡æ˜¯ä¸èƒ½è¢«åƒåœ¾å›æ”¶ â™»ï¸ï¼Œå› ä¸ºåœ¨ä»£ç è¿è¡Œä¹‹åéœ€è¦åœ¨å¼€å‘å·¥å…·èƒ½æŸ¥çœ‹å¯¹è±¡ä¿¡æ¯ã€‚æ‰€ä»¥æœ€å¥½ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­`console.log`ä»»ä½•å¯¹è±¡ã€‚

### å®ä¾‹------>[demos/log.html](./demos/log.html)

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Leaker</title>
</head>

<body>
  <input type="button" value="click">
  <script>
    !function () {
      function Leaker() {
        this.init();
      };
      Leaker.prototype = {
        init: function () {
          this.name = (Array(100000)).join('*');
          console.log("Leaking an object %o: %o", (new Date()), this);// thiså¯¹è±¡ä¸èƒ½è¢«å›æ”¶
        },

        destroy: function () {
          // do something....
        }
      };
      document.querySelector('input').addEventListener('click', function () {
        new Leaker();
      }, false);
    }()
  </script>
</body>

</html>
```

è¿™é‡Œç»“åˆ Chrome çš„ Devtoolsâ€“>Performance åšä¸€äº›åˆ†æï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  å¼€å¯ã€Performanceã€‘é¡¹çš„è®°å½•
2.  æ‰§è¡Œä¸€æ¬¡ CGï¼Œåˆ›å»ºåŸºå‡†å‚è€ƒçº¿
3.  è¿ç»­å•å‡»ã€clickã€‘æŒ‰é’®ä¸‰æ¬¡ï¼Œæ–°å»ºä¸‰ä¸ª Leaker å¯¹è±¡
4.  æ‰§è¡Œä¸€æ¬¡ CG
5.  åœæ­¢è®°å½•

![](./images/console_1.png)

å¯ä»¥çœ‹å‡ºã€JS Heapã€‘çº¿æœ€åæ²¡æœ‰é™å›åˆ°åŸºå‡†å‚è€ƒçº¿çš„ä½ç½®ï¼Œæ˜¾ç„¶å­˜åœ¨æ²¡æœ‰è¢«å›æ”¶çš„å†…å­˜ã€‚å¦‚æœå°†ä»£ç ä¿®æ”¹ä¸ºï¼š

```js
!(function() {
  function Leaker() {
    this.init();
  }
  Leaker.prototype = {
    init: function() {
      this.name = Array(100000).join('*');
    },

    destroy: function() {
      // do something....
    },
  };
  document.querySelector('input').addEventListener(
    'click',
    function() {
      new Leaker();
    },
    false,
  );
})();
```

å»æ‰`console.log("Leaking an object %o: %o", (new Date()), this);`è¯­å¥ã€‚é‡å¤ä¸Šè¿°çš„æ“ä½œæ­¥éª¤ï¼Œåˆ†æç»“æœå¦‚ä¸‹ï¼š

![](./images/console_2.png)

ä»å¯¹æ¯”åˆ†æç»“æœå¯çŸ¥ï¼Œ`console.log`æ‰“å°çš„å¯¹è±¡æ˜¯ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶çš„ã€‚å› æ­¤æœ€å¥½ä¸è¦åœ¨é¡µé¢ä¸­`console.log`ä»»ä½•å¤§å¯¹è±¡ï¼Œè¿™æ ·å¯èƒ½ä¼šå½±å“é¡µé¢çš„æ•´ä½“æ€§èƒ½ï¼Œç‰¹åˆ«åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ã€‚é™¤äº†`console.log`å¤–ï¼Œå¦å¤–è¿˜æœ‰`console.dir`ã€`console.error`ã€`console.warn`ç­‰éƒ½å­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ï¼Œè¿™äº›ç»†èŠ‚éœ€è¦ç‰¹åˆ«çš„å…³æ³¨ã€‚

## closures(é—­åŒ…)

å½“ä¸€ä¸ªå‡½æ•° A è¿”å›ä¸€ä¸ªå†…è”å‡½æ•° Bï¼Œå³ä½¿å‡½æ•° A æ‰§è¡Œå®Œï¼Œå‡½æ•° B ä¹Ÿèƒ½è®¿é—®å‡½æ•° A ä½œç”¨åŸŸå†…çš„å˜é‡ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªé—­åŒ…â€”â€”â€”â€”â€”â€”æœ¬è´¨ä¸Šé—­åŒ…æ˜¯å°†å‡½æ•°å†…éƒ¨å’Œå¤–éƒ¨è¿æ¥èµ·æ¥çš„ä¸€åº§æ¡¥æ¢ã€‚

```js
function foo(message) {
  function closure() {
    console.log(message);
  }
  return closure;
}

// ä½¿ç”¨
var bar = foo('hello closure!');
bar(); // è¿”å› 'hello closure!'
```

åœ¨å‡½æ•° foo å†…åˆ›å»ºçš„å‡½æ•° closure å¯¹è±¡æ˜¯ä¸èƒ½è¢«å›æ”¶æ‰çš„ï¼Œå› ä¸ºå®ƒè¢«å…¨å±€å˜é‡ bar å¼•ç”¨ï¼Œå¤„äºä¸€ç›´å¯è®¿é—®çŠ¶æ€ã€‚é€šè¿‡æ‰§è¡Œ`bar()`å¯ä»¥æ‰“å°å‡º`hello closure!`ã€‚å¦‚æœæƒ³é‡Šæ”¾æ‰å¯ä»¥å°†`bar = null`å³å¯ã€‚

<u>**ç”±äºé—­åŒ…ä¼šæºå¸¦åŒ…å«å®ƒçš„å‡½æ•°çš„ä½œç”¨åŸŸï¼Œå› æ­¤ä¼šæ¯”å…¶ä»–å‡½æ•°å ç”¨æ›´å¤šçš„å†…å­˜ã€‚è¿‡åº¦ä½¿ç”¨é—­åŒ…å¯èƒ½ä¼šå¯¼è‡´å†…å­˜å ç”¨è¿‡å¤šã€‚**</u>

### å®ä¾‹------>[demos/closures.html](./demos/closures.html)

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Closure</title>
</head>

<body>
  <p>ä¸æ–­å•å‡»ã€clickã€‘æŒ‰é’®</p>
  <button id="click_button">Click</button>
  <script>
    function f() {
      var str = Array(10000).join('#');
      var foo = {
        name: 'foo'
      }
      function unused() {
        var message = 'it is only a test message';
        str = 'unused: ' + str;
      }
      function getData() {
        return 'data';
      }
      return getData;
    }

    var list = [];

    document.querySelector('#click_button').addEventListener('click', function () {
      list.push(f());
    }, false);
  </script>
</body>

</html>
```

è¿™é‡Œç»“åˆ Chrome çš„ Devtools->Memory å·¥å…·è¿›è¡Œåˆ†æï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  é€‰ä¸­ã€Record allocation timelineã€‘é€‰é¡¹
2.  æ‰§è¡Œä¸€æ¬¡ CG
3.  å•å‡»ã€startã€‘æŒ‰é’®å¼€å§‹è®°å½•å †åˆ†æ
4.  è¿ç»­å•å‡»ã€clickã€‘æŒ‰é’®åå¤šæ¬¡
5.  åœæ­¢è®°å½•å †åˆ†æ

![closure](./images/closure1.png)

ä¸Šå›¾ä¸­è“è‰²æŸ±å½¢æ¡è¡¨ç¤ºéšç€æ—¶é—´æ–°åˆ†é…çš„å†…å­˜ã€‚é€‰ä¸­å…¶ä¸­æŸæ¡è“è‰²æŸ±å½¢æ¡ï¼Œè¿‡æ»¤å‡ºå¯¹åº”æ–°åˆ†é…çš„å¯¹è±¡ï¼š

![closure](./images/closure2.png)

æŸ¥çœ‹å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯ï¼š

![closure](./images/closure3.png)

ä»å›¾å¯çŸ¥ï¼Œåœ¨è¿”å›çš„é—­åŒ…ä½œç”¨é“¾(Scopes)ä¸­æºå¸¦æœ‰å®ƒæ‰€åœ¨å‡½æ•°çš„ä½œç”¨åŸŸï¼Œä½œç”¨åŸŸä¸­è¿˜åŒ…å«ä¸€ä¸ª str å­—æ®µã€‚è€Œ str å­—æ®µå¹¶æ²¡æœ‰åœ¨è¿”å› getData()ä¸­ä½¿ç”¨è¿‡ã€‚ä¸ºä»€ä¹ˆä¼šå­˜åœ¨åœ¨ä½œç”¨åŸŸä¸­ï¼ŒæŒ‰ç†åº”è¯¥è¢« GC å›æ”¶æ‰ï¼Œ why:question:

åŸå› æ˜¯åœ¨ç›¸åŒä½œç”¨åŸŸå†…åˆ›å»ºçš„å¤šä¸ªå†…éƒ¨å‡½æ•°å¯¹è±¡æ˜¯å…±äº«åŒä¸€ä¸ª[å˜é‡å¯¹è±¡ï¼ˆvariable objectï¼‰](http://dmitrysoshnikov.com/ecmascript/chapter-2-variable-object/)ã€‚å¦‚æœåˆ›å»ºçš„å†…éƒ¨å‡½æ•°æ²¡æœ‰è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œä¸ç®¡å†…éƒ¨å‡½æ•°æ˜¯å¦å¼•ç”¨å¤–éƒ¨å‡½æ•°çš„å˜é‡å’Œå‡½æ•°ï¼Œåœ¨å¤–éƒ¨å‡½æ•°æ‰§è¡Œå®Œï¼Œå¯¹åº”å˜é‡å¯¹è±¡ä¾¿ä¼šè¢«é”€æ¯ã€‚åä¹‹ï¼Œå¦‚æœå†…éƒ¨å‡½æ•°ä¸­å­˜åœ¨æœ‰å¯¹å¤–éƒ¨å‡½æ•°å˜é‡æˆ–å‡½æ•°çš„è®¿é—®ï¼ˆå¯ä»¥ä¸æ˜¯è¢«å¼•ç”¨çš„å†…éƒ¨å‡½æ•°ï¼‰ï¼Œå¹¶ä¸”å­˜åœ¨æŸä¸ªæˆ–å¤šä¸ªå†…éƒ¨å‡½æ•°è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šå½¢æˆé—­åŒ…ï¼Œå¤–éƒ¨å‡½æ•°çš„å˜é‡å¯¹è±¡å°±ä¼šå­˜åœ¨äºé—­åŒ…å‡½æ•°çš„ä½œç”¨åŸŸé“¾ä¸­ã€‚è¿™æ ·ç¡®ä¿äº†é—­åŒ…å‡½æ•°æœ‰æƒè®¿é—®å¤–éƒ¨å‡½æ•°çš„æ‰€æœ‰å˜é‡å’Œå‡½æ•°ã€‚äº†è§£äº†é—®é¢˜äº§ç”Ÿçš„åŸå› ï¼Œä¾¿å¯ä»¥å¯¹ç—‡ä¸‹è¯äº†ã€‚å¯¹ä»£ç åšå¦‚ä¸‹ä¿®æ”¹ï¼š

```js
function f() {
  var str = Array(10000).join('#');
  var foo = {
    name: 'foo',
  };
  function unused() {
    var message = 'it is only a test message';
    // str = 'unused: ' + str; //åˆ é™¤è¯¥æ¡è¯­å¥
  }
  function getData() {
    return 'data';
  }
  return getData;
}

var list = [];

document.querySelector('#click_button').addEventListener(
  'click',
  function() {
    list.push(f());
  },
  false,
);
```

getData()å’Œ unused()å†…éƒ¨å‡½æ•°å…±äº« f å‡½æ•°å¯¹åº”çš„å˜é‡å¯¹è±¡ï¼Œå› ä¸º unused()å†…éƒ¨å‡½æ•°è®¿é—®äº† f ä½œç”¨åŸŸå†… str å˜é‡ï¼Œæ‰€ä»¥ str å­—æ®µå­˜åœ¨äº f å˜é‡å¯¹è±¡ä¸­ã€‚åŠ ä¸Š getData()å†…éƒ¨å‡½æ•°è¢«è¿”å›ï¼Œè¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ï¼Œå½¢æˆäº†é—­åŒ…ï¼Œå› æ­¤å¯¹åº”çš„ f å˜é‡å¯¹è±¡å­˜åœ¨äºé—­åŒ…å‡½æ•°çš„ä½œç”¨åŸŸé“¾ä¸­ã€‚è¿™é‡Œåªè¦å°†å‡½æ•° unused ä¸­`str = 'unused: ' + str;`è¯­å¥åˆ é™¤ä¾¿å¯è§£å†³é—®é¢˜ã€‚

![closure](./images/closure4.png)

æŸ¥çœ‹ä¸€ä¸‹é—­åŒ…ä¿¡æ¯ï¼š

![closure](./images/closure5.png)

## DOM æ³„éœ²

åœ¨ JavaScript ä¸­ï¼ŒDOM æ“ä½œæ˜¯éå¸¸è€—æ—¶çš„ã€‚å› ä¸º JavaScript/ECMAScript å¼•æ“ç‹¬ç«‹äºæ¸²æŸ“å¼•æ“ï¼Œè€Œ DOM æ˜¯ä½äºæ¸²æŸ“å¼•æ“ï¼Œç›¸äº’è®¿é—®éœ€è¦æ¶ˆè€—ä¸€å®šçš„èµ„æºã€‚å¦‚ Chrome æµè§ˆå™¨ä¸­ DOM ä½äº WebCoreï¼Œè€Œ JavaScript/ECMAScript ä½äº V8 ä¸­ã€‚å‡å¦‚å°† JavaScript/ECMAScriptã€DOM åˆ†åˆ«æƒ³è±¡æˆä¸¤åº§å­¤å²›ï¼Œä¸¤å²›ä¹‹é—´é€šè¿‡ä¸€åº§æ”¶è´¹æ¡¥è¿æ¥ï¼Œè¿‡æ¡¥éœ€è¦äº¤çº³ä¸€å®šâ€œè¿‡æ¡¥è´¹â€ã€‚JavaScript/ECMAScript æ¯æ¬¡è®¿é—® DOM æ—¶ï¼Œéƒ½éœ€è¦äº¤çº³â€œè¿‡æ¡¥è´¹â€ã€‚å› æ­¤è®¿é—® DOM æ¬¡æ•°è¶Šå¤šï¼Œè´¹ç”¨è¶Šé«˜ï¼Œé¡µé¢æ€§èƒ½å°±ä¼šå—åˆ°å¾ˆå¤§å½±å“ã€‚[äº†è§£æ›´å¤š:information_source:](http://www.phpied.com/dom-access-optimization/)

![](http://www.phpied.com/wp-content/uploads/2009/12/domlandia.png)

ä¸ºäº†å‡å°‘ DOM è®¿é—®æ¬¡æ•°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“éœ€è¦å¤šæ¬¡è®¿é—®åŒä¸€ä¸ª DOM æ–¹æ³•æˆ–å±æ€§æ—¶ï¼Œä¼šå°† DOM å¼•ç”¨ç¼“å­˜åˆ°ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ã€‚<u>ä½†å¦‚æœåœ¨æ‰§è¡ŒæŸäº›åˆ é™¤ã€æ›´æ–°æ“ä½œåï¼Œå¯èƒ½ä¼šå¿˜è®°é‡Šæ”¾æ‰ä»£ç ä¸­å¯¹åº”çš„ DOM å¼•ç”¨ï¼Œè¿™æ ·ä¼šé€ æˆ DOM å†…å­˜æ³„éœ²ã€‚</u>

### å®ä¾‹------>[demos/dom.html](./demos/dom.html)

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Dom-Leakage</title>
</head>
<body>
  <input type="button" value="remove" class="remove" style="display:none;">
  <input type="button" value="add" class="add">

  <div class="container">
    <pre class="wrapper"></pre>
  </div>
  <script>
    // å› ä¸ºè¦å¤šæ¬¡ç”¨åˆ°pre.wrapperã€div.containerã€input.removeã€input.addèŠ‚ç‚¹ï¼Œå°†å…¶ç¼“å­˜åˆ°æœ¬åœ°å˜é‡ä¸­ï¼Œ
    var wrapper = document.querySelector('.wrapper');
    var container = document.querySelector('.container');
    var removeBtn = document.querySelector('.remove');
    var addBtn = document.querySelector('.add');
    var counter = 0;
    var once = true;
    // æ–¹æ³•
    var hide = function(target){
      target.style.display = 'none';
    }
    var show = function(target){
      target.style.display = 'inline-block';
    }
    // å›è°ƒå‡½æ•°
    var removeCallback = function(){
      removeBtn.removeEventListener('click', removeCallback, false);
      addBtn.removeEventListener('click', addCallback, false);
      hide(addBtn);
      hide(removeBtn);
      container.removeChild(wrapper);
    }
    var addCallback = function(){
      wrapper.appendChild(document.createTextNode('\t' + ++counter + 'ï¼ša new line text\n'));
      // æ˜¾ç¤ºåˆ é™¤æ“ä½œæŒ‰é’®
      if(once){
        show(removeBtn);
        once = false;
      }
    }
    // ç»‘å®šäº‹ä»¶
    removeBtn.addEventListener('click', removeCallback, false);
    addBtn.addEventListener('click', addCallback, false);
  </script>
</body>
</html>
```

è¿™é‡Œç»“åˆ Chrome æµè§ˆå™¨çš„ Devtoolsâ€“>Performance åšä¸€äº›åˆ†æï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  å¼€å¯ã€Performanceã€‘é¡¹çš„è®°å½•
2.  æ‰§è¡Œä¸€æ¬¡ CGï¼Œåˆ›å»ºåŸºå‡†å‚è€ƒçº¿
3.  è¿ç»­å•å‡»ã€addã€‘æŒ‰é’® 6 æ¬¡ï¼Œå¢åŠ  6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹åˆ° pre å…ƒç´ ä¸­
4.  å•å‡»ã€removeã€‘æŒ‰é’®ï¼Œåˆ é™¤åˆšå¢åŠ  6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹å’Œ pre å…ƒå…ƒç´ 
5.  æ‰§è¡Œä¸€æ¬¡ CG
6.  åœæ­¢è®°å½•å †åˆ†æ

![dom](./images/dom1.png)

ä»åˆ†æç»“æœå›¾å¯çŸ¥ï¼Œè™½ç„¶ 6 æ¬¡ add æ“ä½œå¢åŠ  6 ä¸ª Nodeï¼Œä½†æ˜¯ remove æ“ä½œå¹¶æ²¡æœ‰è®© Nodes èŠ‚ç‚¹æ•°ä¸‹é™ï¼Œå³ remove æ“ä½œå¤±è´¥ã€‚å°½ç®¡è¿˜ä¸»åŠ¨æ‰§è¡Œäº†ä¸€æ¬¡ CG æ“ä½œï¼ŒNodes æ›²çº¿ä¹Ÿæ²¡æœ‰ä¸‹é™ã€‚å› æ­¤å¯ä»¥æ–­å®šå†…å­˜æ³„éœ²äº†ï¼é‚£é—®é¢˜æ¥äº†ï¼Œå¦‚ä½•å»æŸ¥æ‰¾é—®é¢˜çš„åŸå› å‘¢ï¼Ÿè¿™é‡Œå¯ä»¥é€šè¿‡ Chrome æµè§ˆå™¨çš„ Devtoolsâ€“>Memory è¿›è¡Œè¯Šæ–­åˆ†æï¼Œæ‰§è¡Œå¦‚ä¸‹æ“ä½œæ­¥éª¤ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  é€‰ä¸­ã€Take heap snapshotã€‘é€‰é¡¹
2.  è¿ç»­å•å‡»ã€addã€‘æŒ‰é’® 6 æ¬¡ï¼Œå¢åŠ  6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹åˆ° pre å…ƒç´ ä¸­
3.  å•å‡»ã€Take snapshotã€‘æŒ‰é’®ï¼Œæ‰§è¡Œä¸€æ¬¡å †å¿«ç…§
4.  å•å‡»ã€removeã€‘æŒ‰é’®ï¼Œåˆ é™¤åˆšå¢åŠ  6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹å’Œ pre å…ƒå…ƒç´ 
5.  å•å‡»ã€Take snapshotã€‘æŒ‰é’®ï¼Œæ‰§è¡Œä¸€æ¬¡å †å¿«ç…§
6.  é€‰ä¸­ç”Ÿæˆçš„ç¬¬äºŒä¸ªå¿«ç…§æŠ¥å‘Šï¼Œå¹¶å°†è§†å›¾ç”±"Summary"åˆ‡æ¢åˆ°"Comparison"å¯¹æ¯”æ¨¡å¼ï¼Œåœ¨[class filter]è¿‡æ»¤è¾“å…¥æ¡†ä¸­è¾“å…¥å…³é”®å­—ï¼š**Detached**

![dom](./images/dom2.png)

ä»åˆ†æç»“æœå›¾å¯çŸ¥ï¼Œå¯¼è‡´æ•´ä¸ª pre å…ƒç´ å’Œ 6 ä¸ªæ–‡æœ¬èŠ‚ç‚¹æ— æ³•åˆ«å›æ”¶çš„åŸå› æ˜¯ï¼šä»£ç ä¸­å­˜åœ¨å…¨å±€å˜é‡`wrapper`å¯¹ pre å…ƒç´ çš„å¼•ç”¨ã€‚çŸ¥é“äº†äº§ç”Ÿçš„é—®é¢˜åŸå› ï¼Œä¾¿å¯å¯¹ç—‡ä¸‹è¯äº†ã€‚å¯¹ä»£ç åšå¦‚ä¸‹å°±ä¿®æ”¹ï¼š

```js
// å› ä¸ºè¦å¤šæ¬¡ç”¨åˆ°pre.wrapperã€div.containerã€input.removeã€input.addèŠ‚ç‚¹ï¼Œå°†å…¶ç¼“å­˜åˆ°æœ¬åœ°å˜é‡ä¸­ï¼Œ
var wrapper = document.querySelector('.wrapper');
var container = document.querySelector('.container');
var removeBtn = document.querySelector('.remove');
var addBtn = document.querySelector('.add');
var counter = 0;
var once = true;
// æ–¹æ³•
var hide = function(target) {
  target.style.display = 'none';
};
var show = function(target) {
  target.style.display = 'inline-block';
};
// å›è°ƒå‡½æ•°
var removeCallback = function() {
  removeBtn.removeEventListener('click', removeCallback, false);
  addBtn.removeEventListener('click', addCallback, false);
  hide(addBtn);
  hide(removeBtn);
  container.removeChild(wrapper);

  wrapper = null; //åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼Œå°†wrapperå¯¹preèŠ‚ç‚¹çš„å¼•ç”¨é‡Šæ”¾æ‰
};
var addCallback = function() {
  wrapper.appendChild(
    document.createTextNode('\t' + ++counter + 'ï¼ša new line text\n'),
  );
  // æ˜¾ç¤ºåˆ é™¤æ“ä½œæŒ‰é’®
  if (once) {
    show(removeBtn);
    once = false;
  }
};
// ç»‘å®šäº‹ä»¶
removeBtn.addEventListener('click', removeCallback, false);
addBtn.addEventListener('click', addCallback, false);
```

åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼Œå°† wrapper å¯¹ pre èŠ‚ç‚¹çš„å¼•ç”¨é‡Šæ”¾æ‰ï¼Œå³åœ¨åˆ é™¤é€»è¾‘ä¸­å¢åŠ `wrapper = null;`è¯­å¥ã€‚å†æ¬¡åœ¨ Devtoolsâ€“>Performance ä¸­é‡å¤ä¸Šè¿°æ“ä½œï¼š

![dom](./images/dom3.png)

### å°è¯•ç‰›åˆ€------>[demos/dom_practice.html](./demos/dom_practice.html)

å†æ¥çœ‹çœ‹ç½‘ä¸Šçš„ä¸€ä¸ªå®ä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Practice</title>
</head>
<body>
  <div id="refA"><ul><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#" id="refB"></a></li></ul></div>
  <div></div>
  <div></div>

  <script>
    var refA = document.getElementById('refA');
    var refB = document.getElementById('refB');
    document.body.removeChild(refA);

    // #refAä¸èƒ½GCå›æ”¶ï¼Œå› ä¸ºå­˜åœ¨å˜é‡refAå¯¹å®ƒçš„å¼•ç”¨ã€‚å°†å…¶å¯¹#refAå¼•ç”¨é‡Šæ”¾ï¼Œä½†è¿˜æ˜¯æ— æ³•å›æ”¶#refAã€‚
    refA = null;

    // è¿˜å­˜åœ¨å˜é‡refBå¯¹#refAçš„é—´æ¥å¼•ç”¨(refBå¼•ç”¨äº†#refBï¼Œè€Œ#refBå±äº#refA)ã€‚å°†å˜é‡refBå¯¹#refBçš„å¼•ç”¨é‡Šæ”¾ï¼Œ#refAå°±å¯ä»¥è¢«GCå›æ”¶ã€‚
    refB = null;
  </script>
</body>
</html>
```

æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€æ¼”ç¤ºï¼š

![](./images/memory.gif)

æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ä½¿ç”¨ Chrome çš„ Devtools å·¥å…·ï¼ŒéªŒè¯ä¸€ä¸‹åˆ†æç»“æœï¼Œå®è·µå¾ˆé‡è¦~~~:high_brightness:

## timers

åœ¨ JavaScript å¸¸ç”¨`setInterval()`æ¥å®ç°ä¸€äº›åŠ¨ç”»æ•ˆæœã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨é“¾å¼`setTimeout()`è°ƒç”¨æ¨¡å¼æ¥å®ç°ï¼š

```js
setTimeout(function() {
  // do something. . . .
  setTimeout(arguments.callee, interval);
}, interval);
```

å¦‚æœåœ¨ä¸éœ€è¦`setInterval()`æ—¶ï¼Œæ²¡æœ‰é€šè¿‡`clearInterval()`æ–¹æ³•ç§»é™¤ï¼Œé‚£ä¹ˆ`setInterval()`ä¼šä¸åœåœ°è°ƒç”¨å‡½æ•°ï¼Œç›´åˆ°è°ƒç”¨`clearInterval()`æˆ–çª—å£å…³é—­ã€‚å¦‚æœé“¾å¼`setTimeout()`è°ƒç”¨æ¨¡å¼æ²¡æœ‰ç»™å‡ºç»ˆæ­¢é€»è¾‘ï¼Œä¹Ÿä¼šä¸€ç›´è¿è¡Œä¸‹å»ã€‚å› æ­¤å†ä¸éœ€è¦é‡å¤å®šæ—¶å™¨æ—¶ï¼Œç¡®ä¿å¯¹å®šæ—¶å™¨è¿›è¡Œæ¸…é™¤ï¼Œé¿å…å ç”¨ç³»ç»Ÿèµ„æºã€‚å¦å¤–ï¼Œåœ¨ä½¿ç”¨`setInterval()`å’Œ`setTimeout()`æ¥å®ç°åŠ¨ç”»æ—¶ï¼Œæ— æ³•ç¡®ä¿å®šæ—¶å™¨æŒ‰ç…§æŒ‡å®šçš„æ—¶é—´é—´éš”æ¥æ‰§è¡ŒåŠ¨ç”»ã€‚ä¸ºäº†èƒ½åœ¨ JavaScript ä¸­åˆ›å»ºå‡ºå¹³æ»‘æµç•…çš„åŠ¨ç”»ï¼Œæµè§ˆå™¨ä¸º JavaScript åŠ¨ç”»æ·»åŠ äº†ä¸€ä¸ªæ–° API-requestAnimationFrame()ã€‚[å…³äº setIntervalã€setTimeout ä¸ requestAnimationFrame å®ç°åŠ¨ç”»ä¸Šçš„åŒºåˆ« â¹ çŒ›å‡» ğŸ˜Š](https://github.com/zhansingsong/js-leakage-patterns/blob/master/requestAnimationFrame/requestAnimationFrame.md)

### å®ä¾‹------>[demos/timers.html](./demos/timers.html)

å¦‚ä¸‹é€šè¿‡`setInterval()`å®ç°ä¸€ä¸ª clock çš„å°å®ä¾‹ï¼Œä¸è¿‡ä»£ç å­˜åœ¨é—®é¢˜çš„ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å…ˆå°è¯•æ‰¾ä¸€ä¸‹é—®é¢˜çš„æ‰€åœ¨~~~~~ğŸ˜
æ“ä½œï¼š

* å•å‡»ã€startã€‘æŒ‰é’®å¼€å§‹ clockï¼ŒåŒæ—¶ web å¼€å‘æ§åˆ¶å°ä¼šæ‰“å°å®æ—¶ä¿¡æ¯
* å•å‡»ã€stopã€‘æŒ‰é’®åœæ­¢ clockï¼ŒåŒæ—¶ web å¼€å‘æ§åˆ¶å°ä¼šè¾“å‡ºåœæ­¢ä¿¡æ¯

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>setInterval</title>
</head>
<body>
  <input type="button" value="start" class="start">
  <input type="button" value="stop" class="stop">

  <script>
    var counter = 0;
    var clock = {
      start: function () {
        setInterval(this.step.bind(null, ++counter), 1000);
      },
      step: function (flag) {
        var date = new Date();
        var h = date.getHours();
        var m = date.getMinutes();
        var s = date.getSeconds();
        console.log("%d-----> %d:%d:%d", flag, h, m, s);
      }
    }
    document.querySelector('.start').addEventListener('click', clock.start.bind(clock), false);
    document.querySelector('.stop').addEventListener('click', function () {
      console.log('----> stop <----');
      clock = null;
    }, false);
  </script>
</body>
</html>
```

ä¸Šè¿°ä»£ç å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

1.  å¦‚æœä¸æ–­çš„å•å‡»ã€startã€‘æŒ‰é’®ï¼Œä¼šæ–­ç”Ÿæˆæ–°çš„ clockã€‚

2.  å•å‡»ã€stopã€‘æŒ‰é’®ä¸èƒ½åœæ­¢ clockã€‚

è¾“å‡ºç»“æœ:

![](./images/setinterval.png)

é’ˆå¯¹æš´éœ²å‡ºçš„é—®é¢˜ï¼Œå¯¹ä»£ç åšå¦‚ä¸‹ä¿®æ”¹ï¼š

```js
var counter = 0;
var clock = {
  timer: null,
  start: function() {
    // è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜
    if (this.timer) {
      clearInterval(this.timer);
    }
    this.timer = setInterval(this.step.bind(null, ++counter), 1000);
  },
  step: function(flag) {
    var date = new Date();
    var h = date.getHours();
    var m = date.getMinutes();
    var s = date.getSeconds();
    console.log('%d-----> %d:%d:%d', flag, h, m, s);
  },
  // è§£å†³ç¬¬äºŒä¸ªé—®é¢˜
  destroy: function() {
    console.log('----> stop <----');
    clearInterval(this.timer);
    node = null;
    counter = void 0;
  },
};
document
  .querySelector('.start')
  .addEventListener('click', clock.start.bind(clock), false);
document
  .querySelector('.stop')
  .addEventListener('click', clock.destroy.bind(clock), false);
```

## EventListener

åšç§»åŠ¨å¼€å‘æ—¶ï¼Œéœ€è¦å¯¹ä¸åŒè®¾å¤‡å°ºå¯¸åšé€‚é…ã€‚å¦‚åœ¨å¼€å‘ç»„ä»¶æ—¶ï¼Œæœ‰æ—¶éœ€è¦è€ƒè™‘å¤„ç†æ¨ªç«–å±é€‚é…é—®é¢˜ã€‚ä¸€èˆ¬åšæ³•ï¼Œåœ¨æ¨ªç«–å±å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦å°†ç»„ä»¶é”€æ¯åå†é‡æ–°ç”Ÿæˆã€‚è€Œåœ¨ç»„ä»¶ä¸­ä¼šå¯¹å…¶è¿›è¡Œç›¸å…³äº‹ä»¶ç»‘å®šï¼Œå¦‚æœåœ¨é”€æ¯ç»„ä»¶æ—¶ï¼Œæ²¡æœ‰å°†ç»„ä»¶çš„äº‹ä»¶è§£ç»‘ï¼Œåœ¨æ¨ªç«–å±å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šä¸æ–­åœ°å¯¹ç»„ä»¶è¿›è¡Œäº‹ä»¶ç»‘å®šã€‚è¿™æ ·ä¼šå¯¼è‡´ä¸€äº›å¼‚å¸¸ï¼Œç”šè‡³å¯èƒ½ä¼šå¯¼è‡´é¡µé¢å´©æ‰ã€‚

### å®ä¾‹------>[demos/callbacks.html](./demos/callbacks.html)

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>callbacks</title>
</head>
<body>
  <div class="container"></div>
  <script>
    var container = document.querySelector('.container');
    var counter = 0;
    var createHtml = function (n, counter) {
      var template = `${(new Array(n)).join(`<div>${counter}: this is a new data <input type="button" value="remove"></div>`)}`
      container.innerHTML = template;
    }

    var resizeCallback = function (init) {
      createHtml(10, ++counter);
      // äº‹ä»¶å§”æ‰˜
      container.addEventListener('click', function (event){
        var target = event.target;
          if(target.tagName === 'INPUT'){
              container.removeChild(target.parentElement)
          }
      }, false);
    }
    window.addEventListener('resize', resizeCallback, false);
    resizeCallback(true);
  </script>
</body>
</html>
```

é¡µé¢æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œè¿™é‡Œç»“åˆ Devtoolsâ€“>Performance åˆ†æä¸€ä¸‹é—®é¢˜æ‰€åœ¨ï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

<u>**:warning:æ³¨ï¼šæœ€å¥½åœ¨éšè—çª—å£ä¸­è¿›è¡Œåˆ†æå·¥ä½œï¼Œé¿å…æµè§ˆå™¨æ’ä»¶å½±å“åˆ†æç»“æœ**</u>

1.  å¼€å¯ Performance é¡¹çš„è®°å½•
2.  æ‰§è¡Œä¸€æ¬¡ CGï¼Œåˆ›å»ºåŸºå‡†å‚è€ƒçº¿
3.  å¯¹çª—å£å¤§å°è¿›è¡Œè°ƒæ•´
4.  æ‰§è¡Œä¸€æ¬¡ CG
5.  åœæ­¢è®°å½•

![callbacks](./images/callback.png)

å¦‚åˆ†æç»“æœæ‰€ç¤ºï¼Œåœ¨çª—å£å¤§å°å˜åŒ–æ—¶ï¼Œä¼šä¸æ–­åœ°å¯¹`container`æ·»åŠ ä»£ç†äº‹ä»¶ã€‚

åŒä¸€ä¸ªå…ƒç´ èŠ‚ç‚¹æ³¨å†Œäº†å¤šä¸ªç›¸åŒçš„ EventListenerï¼Œé‚£ä¹ˆé‡å¤çš„å®ä¾‹ä¼šè¢«æŠ›å¼ƒã€‚è¿™ä¹ˆåšä¸ä¼šè®©å¾— EventListener è¢«é‡å¤è°ƒç”¨ï¼Œä¹Ÿä¸éœ€è¦ç”¨ removeEventListener æ‰‹åŠ¨æ¸…é™¤å¤šä½™çš„ EventListenerï¼Œå› ä¸ºé‡å¤çš„éƒ½è¢«è‡ªåŠ¨æŠ›å¼ƒäº†ã€‚è€Œè¿™æ¡è§„åˆ™åªæ˜¯é’ˆå¯¹äºå‘½åå‡½æ•°ã€‚[å¯¹äºåŒ¿åå‡½æ•°ï¼Œæµè§ˆå™¨ä¼šå°†å…¶çœ‹åšä¸åŒçš„ EventListener](https://triangle717.wordpress.com/2015/12/14/js-avoid-duplicate-listeners/)ï¼Œæ‰€ä»¥åªè¦å°†åŒ¿åçš„ EventListenerï¼Œå‘½åä¸€ä¸‹å°±å¯ä»¥è§£å†³é—®é¢˜ï¼š

```js
var container = document.querySelector('.container');
var counter = 0;
var createHtml = function(n, counter) {
  var template = `${new Array(n).join(
    `<div>${counter}: this is a new data <input type="button" value="remove"></div>`,
  )}`;
  container.innerHTML = template;
};
//
var clickCallback = function(event) {
  var target = event.target;
  if (target.tagName === 'INPUT') {
    container.removeChild(target.parentElement);
  }
};
var resizeCallback = function(init) {
  createHtml(10, ++counter);
  // äº‹ä»¶å§”æ‰˜
  container.addEventListener('click', clickCallback, false);
};
window.addEventListener('resize', resizeCallback, false);
resizeCallback(true);
```

åœ¨ Devtoolsâ€“>Performance ä¸­å†é‡å¤ä¸Šè¿°æ“ä½œï¼Œåˆ†æç»“æœå¦‚ä¸‹ï¼š
![callback](./images/callback1.png)

åœ¨å¼€å‘ä¸­ï¼Œå¼€å‘è€…å¾ˆå°‘å…³æ³¨äº‹ä»¶è§£ç»‘ï¼Œå› ä¸ºæµè§ˆå™¨å·²ç»ä¸ºæˆ‘ä»¬å¤„ç†å¾—å¾ˆå¥½äº†ã€‚ä¸è¿‡åœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œå› ä¸ºä¸€èˆ¬ç¬¬ä¸‰æ–¹åº“éƒ½å®ç°äº†è‡ªå·±çš„äº‹ä»¶ç»‘å®šï¼Œå¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œåœ¨éœ€è¦é”€æ¯äº‹ä»¶ç»‘å®šæ—¶ï¼Œæ²¡æœ‰è°ƒç”¨æ‰€è§£ç»‘æ–¹æ³•ï¼Œå°±å¯èƒ½é€ æˆäº‹ä»¶ç»‘å®šæ•°é‡çš„ä¸æ–­å¢åŠ ã€‚å¦‚ä¸‹é“¾æ¥æ˜¯æˆ‘åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ jqueryï¼Œé‡è§åˆ°ç±»ä¼¼é—®é¢˜ï¼š[jQuery ä¸­å¿˜è®°è§£ç»‘æ³¨å†Œçš„äº‹ä»¶ï¼Œé€ æˆå†…å­˜æ³„éœ² â¹ çŒ›å‡» ğŸ˜Š](https://github.com/zhansingsong/js-leakage-patterns/blob/master/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E4%B9%8BListeners/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E4%B9%8BListeners.md)

## æ€»ç»“

æœ¬æ–‡ä¸»è¦ä»‹ç»äº†å‡ ç§å¸¸è§çš„å†…å­˜æ³„éœ²ã€‚åœ¨å¼€å‘è¿‡ç¨‹ï¼Œéœ€è¦æˆ‘ä»¬ç‰¹åˆ«ç•™æ„ä¸€ä¸‹æœ¬æ–‡æ‰€æ¶‰åŠåˆ°çš„å‡ ç§å†…å­˜æ³„éœ²é—®é¢˜ã€‚å› ä¸ºè¿™äº›éšæ—¶å¯èƒ½å‘ç”Ÿåœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¦‚æœæˆ‘ä»¬å¯¹å®ƒä»¬ä¸äº†è§£æ˜¯å¾ˆéš¾å‘ç°å®ƒä»¬çš„å­˜åœ¨ã€‚å¯èƒ½åœ¨å®ƒä»¬å°†é—®é¢˜å½±å“ç¨‹åº¦æ”¾å¤§æ—¶ï¼Œæ‰ä¼šå¼•èµ·æˆ‘ä»¬çš„å…³æ³¨ã€‚ä¸è¿‡é‚£æ—¶å¯èƒ½å°±æ™šäº†ï¼Œå› ä¸ºäº§å“å¯èƒ½å·²ç»ä¸Šçº¿ï¼Œæ¥ç€å°±ä¼šä¸¥é‡å½±å“äº§å“çš„è´¨é‡å’Œç”¨æˆ·ä½“éªŒï¼Œç”šè‡³å¯èƒ½è®©æˆ‘ä»¬æ‰¿å—å¤§é‡ç”¨æˆ·æµå¤±çš„æŸå¤±ã€‚ä½œä¸ºå¼€å‘çš„æˆ‘ä»¬å¿…é¡»æŠŠå¥½è¿™ä¸ªå…³ï¼Œè®©æˆ‘ä»¬å¼€å‘çš„äº§å“å¸¦ç»™ç”¨æˆ·æœ€å¥½çš„ä½“éªŒã€‚

## å‚è€ƒæ–‡ç« ï¼š

* [An interesting kind of JavaScript memory leak](https://blog.meteor.com/an-interesting-kind-of-javascript-memory-leak-8b47d2e7f156)
* [Memory Leaks in Microsoft Internet Explorer](http://isaacschlueter.com/2006/10/msie-memory-leaks/trackback/index.html)
* [Memory leak when logging complex objects](https://stackoverflow.com/questions/12996129/memory-leak-when-logging-complex-objects)
